<!doctype html>
<html lang="hi">
<head>
<meta charset="utf-8">
<title>рдХрд╛рд░реНрдп рдкреВрд░реНрдгрддрд╛ рдкреНрд░рдорд╛рдг рдкрддреНрд░</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- PDF library (unchanged) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
/* ===== Certificate No / Date alignment ===== */
.cert-row{
  display:flex;
  justify-content:space-between;
  align-items:flex-end;
  margin:4px 0;
}

.cert-left{
  text-align:left;
}

.cert-right{
  text-align:right;
}
/* ================= A4 PAGE FIX ================= */
@page{
  size:A4;
  margin:12mm;
}

body{
  font-family:"Noto Sans Devanagari",Mangal,Arial,sans-serif;
  background:#f2f4f7;
}
body{
  background:
    linear-gradient(rgba(240,244,248,0.75), rgba(240,244,248,0.75)),
    var(--bg-url);
  background-size: cover;
  background-attachment: fixed;
}
#page{
  width:100%;
  max-width:210mm;
  margin:auto;
  background:#fff;
  padding:12mm;
  box-sizing:border-box;
  overflow:hidden; /* prevent blank 2nd page */
  box-shadow:0 0 20px rgba(0,0,0,0.15);
  border:1px solid #cfd8dc;
  position:relative;
}
}
/* ===== PREVIEW TOGGLE ===== */
#page{
  display:none;        /* default hidden */
}

#page.show{
  display:block;       /* when visible */
}

/* ================= HEADER (IMAGE ONLY) ================= */
.header-img{
  width:100%;
  text-align:center;
  margin:0 0 6mm 0; /* only image margin */
}

.header-img img{
  width:100%;            /* ЁЯФС stretch till page margin */
  height:auto;            /* ЁЯФС keep aspect ratio safe */
  max-height:120px;       /* limit so page not overflow */
  object-fit:contain;     /* no distortion */
  display:block;
  margin:0 auto;
}

/* ================= TEXT & FIELDS ================= */
.line{
  display:inline-block;
  min-width:120px;
  border-bottom:1px dotted #000;
  font-weight:bold;
}
.line.filled{
  min-width:auto;
  width:auto;
  margin-right:4px;
}
.filled{
  border-bottom:none !important;
}

p{
  text-align:left;
  line-height:1.25;
  margin:4px 0;
}

.signature{
  text-align:center;
  margin-top:35px;
}

/* ================= CONTROLS ================= */
.controls{
  text-align:center;
  margin:10px 0;
}

.print-hide{display:block;}

@media print{
  body{background:#fff}
  .print-hide{display:none}
}
:root{
  --bg-url: url("https://www.3ds.com/assets/invest/2023-04/engineering-drawing17.jpg");
}
#page > *{
  position:relative;
  z-index:1;
}
/* ===== PREVIEW HIDE / SHOW (RESTORE) ===== */
#page{
  display:none;   /* page load par preview hide */
}

#page.show{
  display:block;  /* button se show */
}
/* ===== CENTER BUTTON CONTROLS ===== */
.controls{
  display:flex;
  justify-content:center;   /* ЁЯСИ horizontal center */
  align-items:center;
  gap:12px;                 /* buttons ke beech gap */
  flex-wrap:wrap;
  text-align:center;
}
/* ===== BUTTON PROFESSIONAL LOOK (OPTIONAL) ===== */
.controls button{
  padding:6px 14px;
  font-size:14px;
  font-weight:500;
  border-radius:4px;
  border:1px solid #b0bec5;
  background:linear-gradient(#ffffff, #eaeff3);
  cursor:pointer;
  transition:all 0.2s ease;
}

.controls button:hover{
  background:linear-gradient(#e3f2fd, #bbdefb);
  border-color:#64b5f6;
}

.controls button:active{
  transform:scale(0.97);
}
</style>
</head>
<body>

<!-- ================= CONTROLS ================= -->
<div class="controls print-hide">
  <label>Upload Letter Head Image:
    <input type="file" id="headerUpload" accept="image/*">
  </label><br><br>
  <label>Work Name рдЪреБрдиреЗрдВ:
    <select id="workSelect">
      <option value="">рд▓реЛрдб рд╣реЛ рд░рд╣рд╛ рд╣реИтАж</option>
    </select>
  </label><br><br>
<button type="button" id="togglePreviewBtn">
  ЁЯСБя╕П Show Preview
</button>
<br><br>
  <button onclick="printPage()">ЁЯЦия╕П Print</button>
  <button onclick="savePDF()">ЁЯУД PDF Save</button>
</div>

<!-- ================= PAGE ================= -->
<div id="page">

  <div class="header-img" id="headerPreview"></div>

<h3 style="text-align:center;margin:6px 0;">рдХрд╛рд░реНрдп рдкреВрд░реНрдгрддрд╛ рдкреНрд░рдорд╛рдг рдкрддреНрд░</h3>

  <div class="cert-row">
  <div class="cert-left">
    <b>рдкреНрд░рдорд╛рдг рдкрддреНрд░ рдХреНрд░рдорд╛рдВрдХ:</b>
    <span class="line" id="CC_No"></span>
  </div>

  <div class="cert-right">
    <b>рджрд┐рдирд╛рдВрдХ:</b>
    <span class="line" id="CC_Date"></span>
  </div>
</div>
  <p>рдЧреНрд░рд╛рдо рдкрдВрдЪрд╛рдпрдд тАУ <span class="line" id="Gram_Panchayat"></span> /
     рдкрдВрдЪрд╛рдпрдд рд╕рдорд┐рддрд┐ тАУ <span class="line" id="Panchayat_Samiti"></span> /
     рдЬрд┐рд▓рд╛ тАУ <span class="line" id="District"></span></p>

  <p>1. рдХрд╛рд░реНрдп рдХрд╛ рдирд╛рдо тАУ <span class="line" style="min-width:260px" id="Work_name"></span></p>

  <p>рдпреЛрдЬрдирд╛ рдХрд╛ рдирд╛рдо тАУ <span class="line" id="Project"></span>
     &nbsp;&nbsp; рдХрд╛рд░реНрдпрдХрд╛рд░реА рд╕рдВрд╕реНрдерд╛ тАУ <span class="line" id="Agency"></span></p>

  <p>2. рдкреНрд░рд╢рд╛рд╕рдирд┐рдХ рд╕реНрд╡реАрдХреГрддрд┐ рдХреНрд░рдорд╛рдВрдХ/рджрд┐рдирд╛рдВрдХ тАУ
     <span class="line" id="AS_No"></span> /
     <span class="line" id="AS_Date"></span></p>

  <p>3. рддрдХрдиреАрдХреА рд╕реНрд╡реАрдХреГрддрд┐ рдХреНрд░рдорд╛рдВрдХ/рджрд┐рдирд╛рдВрдХ тАУ
     <span class="line" id="TS_No"></span> /
     <span class="line" id="TS_Date"></span></p>

  <p>4. рд╡рд┐рддреНрддреАрдп рд╕реНрд╡реАрдХреГрддрд┐ рдХреНрд░рдорд╛рдВрдХ/рджрд┐рдирд╛рдВрдХ тАУ
     <span class="line" id="FS_No"></span> /
     <span class="line" id="FS_Date"></span></p>

  <p>5. рд╕реНрд╡реАрдХреГрдд рд░рд╛рд╢рд┐  тАУ <span class="line" id="Total_Amt"></span>рд░реБрдкрдпреЗ</p>

  <p>6. рдХрд╛рд░реНрдп рд╢реБрд░реВ рдХрд░рдиреЗ рдХреА рддрд┐рдерд┐ тАУ <span class="line" id="Work_Start_Date"></span></p>

  <p>7. рдХрд╛рд░реНрдп рдкреВрд░реНрдг рд╣реЛрдиреЗ рдХреА рддрд┐рдерд┐ тАУ <span class="line" id="Work_End_Date"></span></p>

  <p>8. рдХрд╛рд░реНрдп рдкрд░ рд╡реНрдпрдп рд▓реЗрдЦреЗ рдХреЗ рдЕрдиреБрд╕рд╛рд░ тАУ</p>
  <p>&nbsp;&nbsp;рдЕ. рд╢реНрд░рдо рдорджрдГ <span class="line" id="Record_Labour_Amt"></span>рд░реБрдкрдпреЗ </p> 
  <p>&nbsp;&nbsp;рдм. рд╕рд╛рдордЧреНрд░реА рдорджрдГ <span class="line" id="Record_Material_Amt"></span>рд░реБрдкрдпреЗ</p>  
  <p>&nbsp;&nbsp;рдХреБрд▓ рд░рд╛рд╢рд┐ тАУ <span class="line" id="Total_Record_Amt"></span>рд░реБрдкрдпреЗ </p> 

  <p>9. рдореВрд▓реНрдпрд╛рдВрдХрди рдХреЗ рдЕрдиреБрд╕рд╛рд░ тАУ</p>
  <p>&nbsp;&nbsp;рдЕ. рд╢реНрд░рдо рдорджрдГ <span class="line" id="MB_Labour_Amt"></span>рд░реБрдкрдпреЗ </p> 
  <p>&nbsp;&nbsp;рдм. рд╕рд╛рдордЧреНрд░реА рдорджрдГ <span class="line" id="MB_Material_Amt"></span>рд░реБрдкрдпреЗ </p> 
  <p>&nbsp;&nbsp;рдХреБрд▓ рд░рд╛рд╢рд┐ тАУ <span class="line" id="Total_MB_Amt"></span>рд░реБрдкрдпреЗ </p> 

  <p>10. рдЕрдиреБрдордд рдХреБрд▓ рд░рд╛рд╢рд┐ тАУ <span class="line" id="Payble_Amt"></span>рд░реБрдкрдпреЗ </p> 

  <p>11. рдкреНрд░рдорд╛рдгрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдХрд┐ рдЙрдкрд░реЛрдХреНрдд рдХрд╛рд░реНрдп рдХрд╛ рдорд╛рдк рдПрд╡рдВ рдореВрд▓реНрдпрд╛рдВрдХрди рдЧреНрд░рд╛рдореАрдг рдХрд╛рд░реНрдп рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛-2010 рдХреЗ рдЕрдиреБрд╕рд╛рд░ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред рдЙрдкрд░реЛрдХреНрдд рдХрд┐рдпреЗ рдЧрдпреЗ рдХрд╛рд░реНрдп рдХрд╛ рдореВрд▓реНрдпрд╛рдВрдХрди рдЙрдкрд░реЛрдХреНрдд рдмрд┐рдиреНрджреВ рд╕рдВрдЦреНрдпрд╛ -09 рдореЗрдВ рдЙрд▓реНрд▓реЗрдЦрд┐рдд рд╣реИ, рдЬрд┐рд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕реНрд╡реАрдХреГрдд рдХрд╛рд░реНрдп рдкреВрд░реНрдг рдХрд░ рд▓рд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ рддрдерд╛ рдХрд╛рд░реНрдп рдХреА рдлреЛрдЯреЛ рдЬреАрдХреЗрдПрди-2010 рдЕрдиреБ.рд╕рдВ. 21 рдХреЗ рдЕрдиреБрд╕рд╛рд░ рд▓реА рдЬрд╛рдХрд░ рд╕рдВрд▓рдЧреНрди рдХрд░ рджреА рдЧрдИ рд╣реИред рдЙрдХреНрдд рдХрд╛рд░реНрдп рдХреЗ рдорд╛рдк рдХрд╛ рдЗрдиреНрджреНрд░рд╛рдЬ рдорд╛рдк рдкреБрд╕реНрддрд┐рдХрд╛ рд╕рдВ. <span class="line" id="MB_No"></span>
     рдкреГрд╖реНрда рд╕рдВрдЦреНрдпрд╛ <span class="line" id="MB_Page"></span> рдкрд░ рдХрд░ рджрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред
     рдпрд╣ рднреА рдкреНрд░рдорд╛рдгрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдХрд┐ рдЙрдкрд░реЛрдХреНрдд рд╕реГрдЬрд┐рдд рдкрд░рд┐рд╕рдореНрдкрддрд┐ рдХреЛ рджрд┐рдирд╛рдВрдХ
     <span class="line" id="Asset_Date"></span> рдХреЛ рдХрд╛рд░реНрдпрдХрд╛рд░реА рд╕рдВрд╕реНрдерд╛ рджреНрд╡рд╛рд░рд╛
     <span class="line" id="Handover_To"></span> рд╡рд┐рднрд╛рдЧ рдХреЛ рд╣рд╕реНрддрд╛рдиреНрддрд░рд┐рдд рдХрд░ рджрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред
     рдкрд░рд┐рд╕рдореНрдкрддрд┐ рдкрдВрдЬрд┐рдХрд╛ рд░рдЬрд┐рд╕реНрдЯрд░ рдХреНрд░рдо рд╕рдВ. <span class="line" id="Asset_No"></span> рдкрд░ рдЗрдиреНрджреНрд░рд╛рдЬ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред</p>

  <p>рджрд┐рдирд╛рдВрдХрдГ <span class="line" id="Asset_Date2"></span></p>

  <div class="signature">рд╣рд╕реНрддрд╛рдХреНрд╖рд░<br>(рд╕рдХреНрд╖рдо рдЕрдзрд┐рдХрд╛рд░реА)</div>
</div>

<script>
window.onafterprint = () => {
  // print ke baad preview wapas hide
  pageEl.classList.remove('show');
  toggleBtn.textContent = 'ЁЯСБя╕П Show Preview';
};
/* ================= API ================= */
const API_URL = "https://script.google.com/macros/s/AKfycbyjIMIRYrDR9GoCyW4Q2RrgoyqVZ_esXvpcz4rvYZra1U8FZMti-Cg6eg-JN2j1wVQ7BQ/exec?action=getWorks";

fetch(API_URL)
.then(r=>r.json())
.then(data=>{
  if(!Array.isArray(data)) return;
  const sel=document.getElementById('workSelect');
  sel.innerHTML='<option value="">-- Work Name рдЪреБрдиреЗрдВ --</option>';
  data.forEach(row=>{
    const o=document.createElement('option');
    o.value=row.Work_name;
    o.textContent=row.Work_name;
    o.dataset.row=JSON.stringify(row);
    sel.appendChild(o);
  });
});

function formatDate(val){
  if(!val) return '';
  // If already in DD/MM/YYYY, return as is
  if(typeof val === 'string' && val.includes('/')) return val;
  const d = new Date(val);
  if(isNaN(d)) return '';
  const dd = String(d.getDate()).padStart(2,'0');
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const yy = d.getFullYear();
  return `${dd}/${mm}/${yy}`;
}
function printPage(){
  // ЁЯФС ensure preview visible
  pageEl.classList.add('show');

  // slight delay so browser render kar le
  setTimeout(() => {
    window.print();
  }, 100);
}
function setVal(id,val){
  const el = document.getElementById(id);
  if(!el) return;

  if(val){
    // date fields formatting
    if(/Date/.test(id)){
      el.textContent = formatDate(val);
    }else{
      el.textContent = val;
    }
    el.classList.add('filled');
  }else{
    el.textContent = '';
  }
}

document.getElementById('workSelect').addEventListener('change',function(){
  if(!this.value) return;
  const r=JSON.parse(this.selectedOptions[0].dataset.row);
  const keys=[
    'Gram_Panchayat','Panchayat_Samiti','District','Work_name','Project','Agency',
    'AS_No','AS_Date','TS_No','TS_Date','FS_No','FS_Date','Total_Amt',
    'Work_Start_Date','Work_End_Date','Record_Labour_Amt','Record_Material_Amt',
    'Total_Record_Amt','MB_Labour_Amt','MB_Material_Amt','Total_MB_Amt',
    'Payble_Amt','MB_No','MB_Page','Asset_Date','Asset_No','Handover_To','CC_No','CC_Date'
  ];
  keys.forEach(k=>setVal(k,r[k]));
  setVal('Asset_Date2',r.Asset_Date);
});

/* ================= HEADER IMAGE ================= */
document.getElementById('headerUpload').onchange=e=>{
  const f=e.target.files[0];
  if(!f) return;
  const r=new FileReader();
  r.onload=ev=>document.getElementById('headerPreview').innerHTML=`<img src="${ev.target.result}">`;
  r.readAsDataURL(f);
};

/* ================= PDF SAVE (ONE PAGE) ================= */
function savePDF(){
  const wasHidden = !pageEl.classList.contains('show');

  // PDF ke liye preview show
  pageEl.classList.add('show');

  const workName = document.getElementById('workSelect').value;

  html2pdf().set({
    filename:'karya-poornata-praman-patra.pdf',
    margin:0,
    pagebreak:{mode:'avoid-all'},
    html2canvas:{
      scale:2,
      scrollY:0,
      windowHeight:pageEl.scrollHeight
    },
    jsPDF:{
      unit:'mm',
      format:'a4',
      orientation:'portrait'
    }
  }).from(pageEl).save().then(()=>{

    // тЬЕ CC mark issued
    fetch("https://script.google.com/macros/s/AKfycbyjIMIRYrDR9GoCyW4Q2RrgoyqVZ_esXvpcz4rvYZra1U8FZMti-Cg6eg-JN2j1wVQ7BQ/exec?action=markCC&work="
  + encodeURIComponent(workName)
)
      .then(()=> refreshDropdown());   // ЁЯСИ CALL HERE

    // preview wapas hide
    if(wasHidden){
      pageEl.classList.remove('show');
      toggleBtn.textContent = 'ЁЯСБя╕П Show Preview';
    }
  });
}
/* ================= REFRESH DROPDOWN ================= */
function refreshDropdown(){
  fetch("https://script.google.com/macros/s/AKfycbyjIMIRYrDR9GoCyW4Q2RrgoyqVZ_esXvpcz4rvYZra1U8FZMti-Cg6eg-JN2j1wVQ7BQ/exec?action=getWorks"
  )
    .then(r=>r.json())
    .then(data=>{
      const sel = document.getElementById('workSelect');
      sel.innerHTML = '<option value="">-- Work Name рдЪреБрдиреЗрдВ --</option>';

      data.forEach(row=>{
        const o = document.createElement('option');
        o.value = row.Work_name;
        o.textContent = row.Work_name;
        o.dataset.row = JSON.stringify(row);
        sel.appendChild(o);
      });
    });
}
/* ===== PREVIEW TOGGLE LOGIC ===== */
const pageEl = document.getElementById('page');
const toggleBtn = document.getElementById('togglePreviewBtn');

toggleBtn.onclick = () => {
  const isVisible = pageEl.classList.contains('show');

  if(isVisible){
    pageEl.classList.remove('show');
    toggleBtn.textContent = 'ЁЯСБя╕П Show Preview';
  }else{
    pageEl.classList.add('show');
    toggleBtn.textContent = 'ЁЯЩИ Hide Preview';
  }
};
</script>
</body>
</html>
